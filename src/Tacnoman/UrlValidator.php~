<?php

namespace Tacnoman;

class UrlValidator
{
    protected $_changedParams = [
       'src', 'w', 'h', 'q', 'a',
       'zc', 'f', 's', 'cc', 'ct',
    ];

    public static function validateUrlParams()
    {
        $config = \Tacnoman\Config::getInstance();
        $urlParams = [];
        foreach (self::changedParams as $parameter) {
            if (isset($config->appConfigs[$parameter])) {
                $urlParams[$parameter] = $config->appConfigs[$parameter];
            }
        }

        // Check if the style is defined
        if (isset($config->appConfigs['style'])) {
            $style = $config->appConfigs['style'];

            if (isset($config->appConfigs['sizes']) && is_array($config->appConfigs['sizes'])) {
                $sizes = $config->appConfigs['sizes'];

                if (isset($sizes[$style])) {
                    if (!preg_match('/^(\d+)x(\d+)$/', $sizes[$style])) {
                        $this->error(500, 'You must set size as <width>x<height>. Ex: 400x400');
                    }

                    $sizes = explode('x', $sizes[$style]);

                    $config->appConfigs['w'] = $sizes[0];
                    $config->appConfigs['h'] = $sizes[1];
                } else {
                    $this->error(404, 'This style does not exists.');
                }
            }
        } else {
            // Verify if the size defined exists
            if (!isset($config->appConfigs['w']) ||
                !isset($config->appConfigs['h'])
            ) {
                throw new \Exception('You must define the size or style size.');
            }

            $sizeStr = $config->appConfigs['w'].'x'.$config->appConfigs['h'];

            foreach (self::$params['sizes'] as $currentSize) {
                if ($sizeStr == $currentSize) {
                    return true;
                }
            }

            return false;
        }
    }
}
